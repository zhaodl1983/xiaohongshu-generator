# PRD：Markdown 富文本输入 + 智能图片分配功能

## 1. 功能概述

支持用户粘贴 Markdown 格式内容（包含文字和网络图片），AI 自动提取内容并智能分配图片到对应卡片，用户可在预览模式进行调整。

## 2. 用户工作流

```
┌─────────────────────────────────────────────────────────────┐
│  1. 输入阶段                                                 │
│     用户粘贴内容（支持纯文本 / Markdown + 图片）               │
└─────────────────────────────────────────────────────────────┘
                              ↓
┌─────────────────────────────────────────────────────────────┐
│  2. 预处理阶段                                               │
│     - 解析 Markdown 文本                                     │
│     - 提取图片 URL 列表                                      │
│     - 过滤 GIF 图片（自动跳过）                               │
│     - 验证图片 URL 可访问性（失败则静默跳过）                   │
└─────────────────────────────────────────────────────────────┘
                              ↓
┌─────────────────────────────────────────────────────────────┐
│  3. AI 分析阶段                                              │
│     - 生成标题、副标题、标签                                  │
│     - 生成各张卡片的要点                                      │
│     - 智能分配图片到对应卡片（按内容相关度）                    │
└─────────────────────────────────────────────────────────────┘
                              ↓
┌─────────────────────────────────────────────────────────────┐
│  4. 预览/编辑阶段                                            │
│     - 编辑文字内容（标题、副标题、标签、要点）                  │
│     - 调整图片分配（删除、替换、移动）                         │
│     - 手动添加图片（粘贴/拖拽/上传）                          │
└─────────────────────────────────────────────────────────────┘
                              ↓
┌─────────────────────────────────────────────────────────────┐
│  5. 生成/导出阶段                                            │
│     - 渲染图卡                                               │
│     - 导出图片                                               │
└─────────────────────────────────────────────────────────────┘
```

## 3. 输入格式支持

| 输入类型 | 处理方式 |
|---------|---------|
| 纯文本 | 正常处理，生成无图片的卡片 |
| Markdown（无图片） | 正常处理，生成无图片的卡片 |
| Markdown（有图片） | 提取图片，AI 智能分配 |

## 4. 图片处理规则

| 场景 | 处理方式 |
|------|---------|
| GIF 图片 | 自动跳过，不参与分配 |
| 图片 URL 无法访问 | 静默跳过，当作没有这张图片 |
| 图片 > 卡片数量 | AI 丢弃内容相关度低的图片 |
| 图片 < 卡片数量 | AI 只分配到相关度最高的卡片 |
| 图片 = 卡片数量 | 按相关度一一分配 |

## 5. 图片位置与尺寸

| 卡片类型 | 图片位置 | 尺寸规则 |
|---------|---------|---------|
| 封面卡片 | 副标题下方，标签上方 | 自适应高度，最大不超过卡片 40% |
| 内容卡片 | 最后一个要点下方，页码上方 | 自适应高度，最大不超过卡片 40% |

## 6. 图片样式规格

| 项目 | 规格 |
|------|------|
| 数量限制 | 每张卡片最多 1 张 |
| 支持格式 | PNG、JPG、JPEG、WebP |
| 不支持格式 | GIF（自动跳过） |
| 图片来源 | Markdown URL / 粘贴 / 拖拽 / 本地上传 |
| 适配方式 | 自动裁剪（object-fit: cover） |
| 是否必须 | 可选，用户可不添加图片 |

## 7. AI 输出的 JSON 结构

```json
{
  "cover_title": "封面大标题",
  "cover_subtitle": "封面副标题",
  "cover_tags": ["标签1", "标签2", "标签3"],
  "cover_image": "https://example.com/cover.png",
  "slides": [
    {
      "title": "第1张幻灯片标题",
      "content": ["要点1", "要点2", "要点3"],
      "image": "https://example.com/slide1.png"
    },
    {
      "title": "第2张幻灯片标题",
      "content": ["要点1", "要点2", "要点3"],
      "image": null
    }
  ]
}
```

## 8. 预览模式功能清单

### 文字编辑
- ✅ 修改封面标题、副标题
- ✅ 修改封面标签
- ✅ 修改每张卡片的标题
- ✅ 修改每张卡片的要点

### 图片管理
- ✅ 查看 AI 分配的图片
- ✅ 删除图片
- ✅ 替换图片
- ✅ 为无图片的卡片手动添加图片
- ✅ 支持粘贴（Ctrl+V）
- ✅ 支持拖拽
- ✅ 支持本地上传

## 9. 各风格的图片样式

| 风格 | 边框样式 | 圆角 | 特殊效果 |
|------|---------|------|---------|
| xiaohongshu | 无边框 | 12px | 轻微阴影 |
| apple | 无边框 | 28px | 大阴影 |
| dopamine | 6px 黑色实线 | 20px | 阴影偏移 |
| capsule | 2px 霓虹绿 | 16px | 发光效果 |
| tech | 1px 青色 | 0px（切角） | 无 |
| notion | 无边框 | 8px | 无 |
| memphis | 3px 黑色实线 | 0px | 阴影偏移 |
| chinese | 2px 红色 | 4px | 无 |
| polaroid | 白色厚边框 | 0px | 胶片质感 |

## 10. 技术实现要点

### 10.1 Markdown 解析
- 使用正则表达式提取图片：`!\[.*?\]\((.*?)\)`
- 过滤 GIF：检查 URL 是否以 `.gif` 结尾
- 验证图片可访问性：发送 HEAD 请求检查状态码

### 10.2 AI Prompt 更新
- 输入：纯文本内容 + 图片 URL 列表
- 输出：包含图片分配的 JSON 结构
- AI 需要根据内容相关度分配图片

### 10.3 前端图片上传
- 支持 paste 事件（Ctrl+V）
- 支持 dragover/drop 事件
- 支持 input[type=file] 上传
- 图片转为 Base64 或上传到服务器

### 10.4 模板更新
- 所有 9 个模板添加图片插槽
- 封面卡片：副标题下方
- 内容卡片：要点下方，页码上方
- 图片样式适配各风格

## 11. 实现优先级

### Phase 1：核心功能
1. Markdown 解析和图片提取
2. AI Prompt 更新（支持图片分配）
3. 模板更新（添加图片插槽）
4. 后端 API 更新

### Phase 2：前端交互
1. 预览模式图片显示
2. 图片删除/替换功能
3. 手动添加图片（粘贴/拖拽/上传）

### Phase 3：优化
1. 图片加载优化
2. 错误处理完善
3. 用户体验优化

---

**文档版本**：v1.1  
**创建日期**：2024-12-26  
**更新日期**：2024-12-26  
**状态**：已实现

## 实现记录

### Phase 1: 核心功能 ✅
- [x] Markdown 解析和图片提取 (`extract_images_from_markdown`)
- [x] 图片 URL 验证 (`validate_image_url`, `filter_valid_images`)
- [x] AI Prompt 更新（支持图片分配）
- [x] 所有 9 个模板添加图片插槽
- [x] 后端 API 更新 (`/preview`, `/upload-image`, `/validate-image-url`)

### Phase 2: 前端交互 ✅
- [x] 预览模式图片显示
- [x] 图片删除/替换功能
- [x] 手动添加图片（粘贴/拖拽/上传）

### 技术实现
- 使用正则表达式提取 Markdown 图片
- HEAD 请求验证图片可访问性
- 自动跳过 GIF 图片
- 图片转 Base64 存储
- 全局粘贴事件监听
